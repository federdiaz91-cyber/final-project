<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title id="pageTitle">Staff Insights Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        /* --- GENERAL AESTHETICS --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* Soft Pink Gradient Background */
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); 
            color: #333;
        }
        .header {
            background-color: #880e4f; /* Deep Pink/Berry */
            color: white;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { margin: 0; font-size: 1.8em; }
        
        .action-group {
            display: flex; 
            align-items: center; 
            gap: 15px;
        }
        
        .lang-switch { display: flex; gap: 10px; }
        .lang-switch button { width: auto; padding: 5px 10px; margin: 0; font-size: 0.9em; }

        /* Button Styling */
        #logout-button, #dashboard-button, #home-button {
            padding: 8px; border-radius: 8px; 
            color: white !important; border: 1px solid #c2185b !important; cursor: pointer;
            transition: background-color 0.2s;
        }
        
        /* Logout Button Style */
        #logout-button {
            background-color: #880e4f !important; 
        }
        #logout-button:hover { 
            background-color: #c2185b !important; 
        }

        /* Dashboard Button Style */
        #dashboard-button {
            background-color: #00897B !important; 
            border-color: #004d40 !important;
            font-weight: bold;
        }
        #dashboard-button:hover {
            background-color: #004d40 !important;
        }

        /* Home Button Style (New) */
        #home-button {
            background-color: #D81B60 !important; 
            border-color: #AD1457 !important;
            font-weight: bold;
        }
        #home-button:hover {
            background-color: #AD1457 !important;
        }
        
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        .kpi-card {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(171, 71, 188, 0.15);
            text-align: center;
        }
        .kpi-card h3 {
            color: #c2185b;
            margin-top: 0;
            font-size: 1.1em;
            border-bottom: 1px dashed #f8bbd0;
            padding-bottom: 5px;
        }
        .kpi-card p {
            font-size: 2.5em;
            font-weight: bold;
            color: #880e4f;
            margin: 5px 0 0;
        }

        /* Cancelled Orders Log */
        .log-section h2 {
            color: #c2185b;
            border-bottom: 2px solid #f8bbd0;
            padding-bottom: 5px;
        }
        .cancelled-table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(171, 71, 188, 0.15);
        }
        .cancelled-table th, .cancelled-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f8bbd0;
        }
        .cancelled-table th {
            background-color: #fce4ec; /* Lightest pink header */
            color: #880e4f;
            font-size: 1em;
        }
        .cancelled-table tbody tr:last-child td {
            border-bottom: none;
        }
        .reason-cell {
            font-style: italic;
            font-size: 0.9em;
            color: #B71C1C;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="mainHeader">Staff Insights Dashboard</h1>
        
        <div class="action-group">

            <button id="home-button" onclick="window.location.href='index.html'">
                Back to Home
            </button>
            
            <button id="dashboard-button" onclick="window.location.href='staff-grading-dashboard.html'">
                Back to Dashboard
            </button>
            
             <div class="lang-switch">
                <button onclick="setLanguage('en')">EN</button>
                <button onclick="setLanguage('es')">ES</button>
                <button onclick="setLanguage('it')">IT</button>
            </div>
            
            <span id="user-display" style="font-weight: bold;"></span>
            <button id="logout-button" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <h3 id="kpiTotalRequests">Total Requests</h3>
                <p id="totalRequestsCount">0</p>
            </div>
            <div class="kpi-card">
                <h3 id="kpiCompletedRequests">Completed Requests</h3>
                <p id="completedRequestsCount">0</p>
            </div>
            <div class="kpi-card">
                <h3 id="kpiCancellationRate">Cancellation Rate</h3>
                <p id="cancellationRate">0.0%</p>
            </div>
        </div>

        <div class="log-section">
            <h2 id="cancelledLogHeader">Cancelled Orders Log</h2>
            <table class="cancelled-table">
                <thead>
                    <tr>
                        <th id="thOrder">Order Pattern</th>
                        <th id="thCancelledBy">Cancelled By</th>
                        <th id="thDate">Date</th>
                        <th id="thReason">Reason</th>
                    </tr>
                </thead>
                <tbody id="cancelledOrdersBody">
                    </tbody>
            </table>
            <p id="noCancelledOrders" style="text-align: center; margin-top: 20px; font-style: italic; display: none;"></p>
        </div>

    </div>

    <script>
        const auth = firebase.auth();
        // Ensure db is correctly initialized from firebase-config.js

        // --- MULTILINGUAL TRANSLATIONS ---
        const translations = {
            en: {
                mainHeader: "Staff Insights Dashboard", logout: "Logout", welcome: "Welcome,", dashboard: "Back to Dashboard", home: "Back to Home",
                kpiTotalRequests: "Total Requests", kpiCompletedRequests: "Completed Requests", kpiCancellationRate: "Cancellation Rate",
                cancelledLogHeader: "Cancelled Orders Log", thOrder: "Order Pattern", thCancelledBy: "Cancelled By", thDate: "Date", thReason: "Reason",
                noCancelledOrders: "No cancelled orders found.",
            },
            es: {
                mainHeader: "Panel de Perspectivas del Personal", logout: "Cerrar Sesi贸n", welcome: "Bienvenido,", dashboard: "Volver al Panel", home: "Volver a Inicio",
                kpiTotalRequests: "Solicitudes Totales", kpiCompletedRequests: "Solicitudes Completadas", kpiCancellationRate: "Tasa de Cancelaci贸n",
                cancelledLogHeader: "Registro de Pedidos Cancelados", thOrder: "Patr贸n del Pedido", thCancelledBy: "Cancelado Por", thDate: "Fecha", thReason: "Raz贸n",
                noCancelledOrders: "No se encontraron pedidos cancelados.",
            },
            it: {
                mainHeader: "Dashboard Statistiche Staff", logout: "Esci", welcome: "Benvenuto,", dashboard: "Torna alla Dashboard", home: "Torna a Casa",
                kpiTotalRequests: "Richieste Totali", kpiCompletedRequests: "Richieste Completate", kpiCancellationRate: "Tasso di Annullamento",
                cancelledLogHeader: "Registro Ordini Annullati", thOrder: "Modello Ordine", thCancelledBy: "Annullato Da", thDate: "Data", thReason: "Motivo",
                noCancelledOrders: "Nessun ordine annullato trovato.",
            }
        };

        let currentLang = 'en';

        function setLanguage(lang) {
            currentLang = lang;
            
            // Static Headers and Labels
            document.getElementById('pageTitle').textContent = translations[lang].mainHeader;
            document.getElementById('mainHeader').textContent = translations[lang].mainHeader;
            document.getElementById('logout-button').textContent = translations[lang].logout;
            document.getElementById('dashboard-button').textContent = translations[lang].dashboard;
            document.getElementById('home-button').textContent = translations[lang].home; // NEW BUTTON LABEL
            
            document.getElementById('kpiTotalRequests').textContent = translations[lang].kpiTotalRequests;
            document.getElementById('kpiCompletedRequests').textContent = translations[lang].kpiCompletedRequests;
            document.getElementById('kpiCancellationRate').textContent = translations[lang].kpiCancellationRate;
            document.getElementById('cancelledLogHeader').textContent = translations[lang].cancelledLogHeader;
            
            document.getElementById('thOrder').textContent = translations[lang].thOrder;
            document.getElementById('thCancelledBy').textContent = translations[lang].thCancelledBy;
            document.getElementById('thDate').textContent = translations[lang].thDate;
            document.getElementById('thReason').textContent = translations[lang].thReason;
            document.getElementById('noCancelledOrders').textContent = translations[lang].noCancelledOrders;

            // Update user display text
            const user = auth.currentUser;
            if (user) {
                document.getElementById('user-display').textContent = `${translations[lang].welcome} ${user.email}`;
            }

            // Re-fetch data to render dynamic content (the log and KPIs) in the new language
            fetchInsights();
        }

        // Default to English on load
        setLanguage('en'); 

        // --- AUTHENTICATION GUARD ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('user-display').textContent = `${translations[currentLang].welcome} ${user.email}`;
                // This call ensures data is loaded on initial successful login
                fetchInsights(); 
            } else {
                // Redirects to login.html (as per the recommended structure)
                window.location.href = 'login.html';
            }
        });

        // --- LOGOUT FUNCTION ---
        function logout() {
            auth.signOut().then(() => {
                // Redirects to login.html (as per the recommended structure)
                window.location.href = 'login.html';
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }
        
        // --- DATA FETCHING AND PROCESSING ---
        function fetchInsights() {
            // Use onSnapshot for real-time updates
            db.collection('gradingRequests').onSnapshot(snapshot => {
                const allRequests = [];
                snapshot.forEach(doc => {
                    allRequests.push(doc.data());
                });

                updateKPIs(allRequests);
                renderCancelledOrders(allRequests);
            }, error => {
                console.error("Error fetching requests:", error);
                // alert("Failed to load insights. Check console.");
            });
        }

        function updateKPIs(requests) {
            const total = requests.length;
            const completed = requests.filter(r => r.status === 'Completed').length;
            const cancelled = requests.filter(r => r.status === 'Cancelled').length;

            const cancellationRate = total > 0 ? ((cancelled / total) * 100).toFixed(1) : '0.0';

            document.getElementById('totalRequestsCount').textContent = total;
            document.getElementById('completedRequestsCount').textContent = completed;
            document.getElementById('cancellationRate').textContent = `${cancellationRate}%`;
        }

        function renderCancelledOrders(requests) {
            const cancelledRequests = requests.filter(r => r.status === 'Cancelled').sort((a, b) => {
                // Sort descending by cancellation date
                const dateA = a.cancelledAt ? a.cancelledAt.toDate().getTime() : 0;
                const dateB = b.cancelledAt ? b.cancelledAt.toDate().getTime() : 0;
                return dateB - dateA;
            });
            
            const tbody = document.getElementById('cancelledOrdersBody');
            const noCancelledOrdersMessage = document.getElementById('noCancelledOrders');
            tbody.innerHTML = ''; // Clear existing rows

            if (cancelledRequests.length === 0) {
                noCancelledOrdersMessage.style.display = 'block';
                noCancelledOrdersMessage.textContent = translations[currentLang].noCancelledOrders;
                return;
            }
            
            noCancelledOrdersMessage.style.display = 'none';

            cancelledRequests.forEach(request => {
                const row = tbody.insertRow();
                
                const patternCell = row.insertCell();
                patternCell.textContent = request.patternName || 'N/A';
                
                const staffCell = row.insertCell();
                staffCell.textContent = request.staffName || 'Unknown Staff';
                
                const dateCell = row.insertCell();
                dateCell.textContent = request.cancelledAt ? request.cancelledAt.toDate().toLocaleDateString() : 'N/A';

                const reasonCell = row.insertCell();
                reasonCell.className = 'reason-cell';
                reasonCell.textContent = request.cancellationReason || 'No reason provided';
            });
        }

    </script>
</body>
</html>
